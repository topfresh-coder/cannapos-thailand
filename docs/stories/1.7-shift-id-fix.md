# Story 1.7 - Shift ID FK Constraint Fix

## Issue Summary

**Problem**: Story 1.7's E2E testing was blocked because `CartSidebar.tsx` uses a hardcoded `shift_id` (`'00000000-0000-0000-0000-000000000001'`) that didn't exist in the database, causing FK constraint violations when creating transactions.

**Impact**:
- Story 1.8 E2E testing blocked (cannot create transactions to test receipt display)
- Story 1.7 transactions fail in local development
- QA validation incomplete

## Root Cause

**File**: [apps/web/src/components/pos/CartSidebar.tsx:109](apps/web/src/components/pos/CartSidebar.tsx#L109)

```typescript
// MVP Workaround: Story 1.7 assumes active shift exists
const TEMP_SHIFT_ID = '00000000-0000-0000-0000-000000000001'; // Temporary MVP workaround
```

This hardcoded UUID was used as a placeholder for Story 1.7 MVP, with the intention of replacing it with real shift management in Story 2.x. However, no corresponding shift record existed in the database, causing FK constraint violations when attempting to create transactions.

## Solution Implemented

**Created Database Seed File**: `supabase/seed.sql`

The seed file creates all necessary test data for local development:

1. **Test Location** (`id: 00000000-0000-0000-0000-000000000001`)
2. **Test Shift Definition** (AM shift, 08:00-16:00)
3. **Test User** (auth.users + public.users with cashier role)
4. **Test Shift** (Open status with the hardcoded UUID)
5. **Test Product** (Flower product for E2E testing)
6. **Test Product Batch** (Active batch with 1000g available)

### Key Records Created

**Test Shift (Resolves FK Constraint)**:
```sql
INSERT INTO shifts (
  id,
  shift_definition_id,
  location_id,
  opened_by_user_id,
  starting_cash_float,
  status,
  opened_at
)
VALUES (
  '00000000-0000-0000-0000-000000000001'::uuid,  -- Matches CartSidebar.tsx hardcoded ID
  '00000000-0000-0000-0000-000000000001'::uuid,
  '00000000-0000-0000-0000-000000000001'::uuid,
  '00000000-0000-0000-0000-000000000001'::uuid,
  2000.00,
  'Open',
  NOW()
);
```

**Test User**:
- Email: `test@cannapos.local`
- Password: `testpass123`
- Role: `cashier`
- Location: Test Location - MVP

## Verification

Run `supabase db reset` to apply all migrations and seed data. The database will now have:

✅ Test shift with ID matching `CartSidebar.tsx` hardcoded value
✅ Test user for authentication
✅ Test product and batch for transaction testing
✅ All FK constraints satisfied

## Testing Impact

### Story 1.7 - Unblocked
- Can now create transactions in local development
- E2E testing possible with test user credentials

### Story 1.8 - Unblocked
- Can now test complete flow: POS → Checkout → Receipt
- Receipt page can display transaction data
- Full QA validation possible

## Files Modified

1. **Created**: `supabase/seed.sql` - Database seed file with test data
2. **No changes needed**: `apps/web/src/components/pos/CartSidebar.tsx` - Hardcoded ID is now valid

## Future Work (Story 2.x - Shift Management)

The hardcoded `TEMP_SHIFT_ID` is still a temporary solution. When implementing proper shift management:

1. Remove hardcoded `TEMP_SHIFT_ID` from `CartSidebar.tsx`
2. Implement shift store/context
3. Add shift open/close functionality
4. Update transaction creation to use active shift from state
5. Add validation to prevent transactions when no shift is open

**File to Update**: `apps/web/src/components/pos/CartSidebar.tsx:109`

**TODO Comment**: Already exists in code
```typescript
// TODO: Story 2.x - Replace with actual shift management from shiftStore
```

## Database Reset Instructions

To apply the seed data:

```bash
cd d:\test
supabase db reset
```

This will:
1. Drop and recreate the database
2. Apply all migrations (enums, tables, triggers, RLS policies)
3. Seed test data from `supabase/seed.sql`

## QA Sign-Off

With this fix applied:
- ✅ Story 1.7 can complete full E2E validation
- ✅ Story 1.8 can complete full E2E validation
- ✅ FK constraint issue resolved
- ✅ Test data available for local development

---

**Date**: 2025-10-15
**Fixed By**: James (Full Stack Developer Agent)
**Model**: claude-sonnet-4-5-20250929
**Issue Source**: Quinn (QA Agent) - Story 1.8 QA Report
